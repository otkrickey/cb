name: Release
on:
  push:
    tags: ["v*"]
jobs:
  build-and-release:
    runs-on: macos-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin
      - uses: Swatinem/rust-cache@v2

      - name: Check macOS SDK version
        id: sdk-check
        run: |
          SDK_VERSION=$(xcrun --show-sdk-version)
          MAJOR=$(echo "$SDK_VERSION" | cut -d. -f1)
          if [ "$MAJOR" -lt 26 ]; then
            echo "::error::macOS SDK $SDK_VERSION does not support Liquid Glass APIs (requires 26.0+). Release build aborted."
            exit 1
          fi

      - run: brew install xcodegen

      - name: Build Rust (arm64)
        run: cargo build --release -p cb-core --target aarch64-apple-darwin

      - name: Build Rust (x86_64)
        run: cargo build --release -p cb-core --target x86_64-apple-darwin

      - name: Create Universal Binary
        run: |
          mkdir -p target/universal-release
          lipo -create \
            target/aarch64-apple-darwin/release/libcb_core.a \
            target/x86_64-apple-darwin/release/libcb_core.a \
            -output target/release/libcb_core.a

      - name: Generate Xcode Project
        run: xcodegen generate

      - name: Build App
        run: |
          xcodebuild -project CB.xcodeproj -scheme CB -configuration Release \
            build \
            CB_CODE_SIGNING_ALLOWED=NO

      - name: Package
        run: |
          BUILD_DIR=$(xcodebuild -project CB.xcodeproj -scheme CB -configuration Release -showBuildSettings | grep -m 1 "BUILT_PRODUCTS_DIR" | awk '{print $3}')
          ditto -c -k --keepParent "$BUILD_DIR/CB.app" CB-${GITHUB_REF_NAME}-universal.zip

      - uses: softprops/action-gh-release@v2
        with:
          files: CB-*.zip
          generate_release_notes: true
          body: |
            ## Architecture
            - Universal Binary (Apple Silicon + Intel)

            ## Installation
            1. Download `CB-${{ github.ref_name }}-universal.zip`
            2. Extract and move `CB.app` to `/Applications`
            3. Launch CB from Applications
